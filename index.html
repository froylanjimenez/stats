<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Consulta Electoral</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0e1a;
    --surface: #111827;
    --surface2: #1a2235;
    --surface3: #0d1420;
    --accent: #e8c84a;
    --accent2: #f97316;
    --text: #f0f4ff;
    --muted: #6b7a99;
    --border: #1e2d47;
    --success: #10b981;
    --error: #ef4444;
    --warning: #f59e0b;
    --info: #38bdf8;
    --purple: #a78bfa;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    padding: 20px 20px 60px;
    position: relative;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(232,200,74,0.025) 1px, transparent 1px),
      linear-gradient(90deg, rgba(232,200,74,0.025) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  body::after {
    content: '';
    position: fixed;
    top: -200px; right: -200px;
    width: 600px; height: 600px;
    background: radial-gradient(circle, rgba(232,200,74,0.06) 0%, transparent 70%);
    pointer-events: none;
    z-index: 0;
  }

  .container {
    width: 100%;
    max-width: 620px;
    position: relative;
    z-index: 1;
    padding-top: 40px;
  }

  /* â”€â”€â”€ HEADER â”€â”€â”€ */
  .header { text-align: center; margin-bottom: 40px; }
  .badge {
    display: inline-block;
    font-size: 11px; font-weight: 600;
    letter-spacing: 3px; text-transform: uppercase;
    color: var(--accent);
    border: 1px solid rgba(232,200,74,0.3);
    padding: 5px 14px; border-radius: 2px;
    margin-bottom: 18px;
  }
  h1 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: clamp(42px, 8vw, 68px);
    letter-spacing: 2px; line-height: 1;
    color: var(--text); margin-bottom: 12px;
  }
  h1 span { color: var(--accent); }
  .subtitle { color: var(--muted); font-size: 14px; font-weight: 300; }

  /* â”€â”€â”€ SEARCH CARD â”€â”€â”€ */
  .search-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 36px; margin-bottom: 24px;
    position: relative; overflow: hidden;
  }
  .search-card::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0; height: 2px;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
  }
  label {
    display: block; font-size: 11px; font-weight: 600;
    letter-spacing: 2px; text-transform: uppercase;
    color: var(--muted); margin-bottom: 10px;
  }
  .input-row { display: flex; gap: 10px; }
  input[type="text"] {
    flex: 1;
    background: var(--surface2); border: 1px solid var(--border);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 18px; font-weight: 500;
    padding: 14px 18px; border-radius: 3px;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
    letter-spacing: 1px;
  }
  input[type="text"]:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(232,200,74,0.08);
  }
  input[type="text"]::placeholder { color: var(--muted); font-size: 15px; letter-spacing: 0; }
  button {
    background: var(--accent); color: #0a0e1a;
    border: none;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 18px; letter-spacing: 1.5px;
    padding: 14px 28px; border-radius: 3px;
    cursor: pointer;
    transition: background 0.15s, transform 0.1s;
    white-space: nowrap;
  }
  button:hover { background: #f0d060; }
  button:active { transform: scale(0.97); }
  button:disabled { background: var(--muted); cursor: not-allowed; transform: none; }

  /* â”€â”€â”€ STATUS â”€â”€â”€ */
  .status-msg {
    text-align: center; font-size: 13px;
    padding: 12px; border-radius: 3px; margin-top: 16px;
    display: none; align-items: center; justify-content: center; gap: 10px;
  }
  .status-msg.error   { display: block; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); color: var(--error); }
  .status-msg.loading { display: flex; background: rgba(232,200,74,0.08); border: 1px solid rgba(232,200,74,0.2); color: var(--accent); }
  .spinner {
    width: 16px; height: 16px;
    border: 2px solid rgba(232,200,74,0.3);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.7s linear infinite; flex-shrink: 0;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* â”€â”€â”€ RESULT CARD (Ãºnico) â”€â”€â”€ */
  .result-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 4px; padding: 36px;
    display: none; position: relative; overflow: hidden;
    animation: slideUp 0.3s ease;
    margin-bottom: 24px;
  }
  .result-card.visible { display: block; }
  .result-card::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
    background: linear-gradient(90deg, var(--success), #34d399);
  }
  .result-header { display: flex; align-items: center; gap: 12px; margin-bottom: 28px; }
  .check-icon {
    width: 36px; height: 36px;
    background: rgba(16,185,129,0.12); border: 1px solid rgba(16,185,129,0.3);
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    font-size: 16px; flex-shrink: 0;
  }
  .result-name { font-family: 'Bebas Neue', sans-serif; font-size: 22px; letter-spacing: 1px; line-height: 1.2; }
  .result-cedula { font-size: 12px; color: var(--muted); letter-spacing: 1px; }
  .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  .info-item { background: var(--surface2); border: 1px solid var(--border); border-radius: 3px; padding: 16px; }
  .info-item.full { grid-column: 1 / -1; }
  .info-label { font-size: 10px; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); margin-bottom: 6px; }
  .info-value { font-size: 16px; font-weight: 500; }
  .info-value.na { color: var(--muted); font-style: italic; font-size: 14px; }
  .info-value.highlight { color: var(--accent); font-family: 'Bebas Neue', sans-serif; font-size: 24px; letter-spacing: 1px; }
  .unique-badge {
    display: inline-flex; align-items: center; gap: 6px;
    font-size: 11px; font-weight: 600; letter-spacing: 1.5px; text-transform: uppercase;
    color: var(--success);
    background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3);
    padding: 5px 12px; border-radius: 2px; margin-top: 18px;
  }

  /* â”€â”€â”€ DUP CARD â”€â”€â”€ */
  .dup-card {
    background: var(--surface); border: 1px solid rgba(245,158,11,0.3);
    border-radius: 4px; padding: 36px;
    display: none; position: relative; overflow: hidden;
    animation: slideUp 0.3s ease; margin-bottom: 24px;
  }
  .dup-card.visible { display: block; }
  .dup-card::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
    background: linear-gradient(90deg, var(--warning), var(--accent2));
  }
  .dup-header { display: flex; align-items: center; gap: 12px; margin-bottom: 22px; }
  .warn-icon {
    width: 36px; height: 36px;
    background: rgba(245,158,11,0.12); border: 1px solid rgba(245,158,11,0.35);
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    font-size: 17px; flex-shrink: 0;
  }
  .dup-title { font-family: 'Bebas Neue', sans-serif; font-size: 20px; letter-spacing: 1px; color: var(--warning); }
  .dup-cedula-label { font-size: 12px; color: var(--muted); letter-spacing: 1px; }
  .dup-count-pill {
    display: inline-block;
    background: rgba(245,158,11,0.08); border: 1px solid rgba(245,158,11,0.3);
    color: var(--warning); font-size: 12px; font-weight: 600; letter-spacing: 1px;
    padding: 3px 12px; border-radius: 20px; margin-bottom: 18px;
  }
  .dup-list { display: flex; flex-direction: column; gap: 10px; }
  .dup-entry {
    background: var(--surface2); border: 1px solid var(--border);
    border-left: 3px solid var(--warning); border-radius: 3px;
    padding: 14px 16px;
    display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 10px;
  }
  .dup-entry-nombre { font-size: 15px; font-weight: 500; }
  .dup-entry-meta { font-size: 12px; color: var(--muted); margin-top: 3px; }
  .dup-name-badge {
    display: inline-block; font-size: 11px; padding: 2px 8px;
    border-radius: 2px; margin-top: 5px; font-weight: 600; letter-spacing: 0.5px;
  }
  .dup-name-badge.match { background: rgba(16,185,129,0.15); color: var(--success); border: 1px solid rgba(16,185,129,0.3); }
  .dup-name-badge.diff  { background: rgba(239,68,68,0.12); color: var(--error); border: 1px solid rgba(239,68,68,0.3); }
  .dup-entry-puesto { font-family: 'Bebas Neue', sans-serif; font-size: 22px; color: var(--accent); letter-spacing: 1px; text-align: right; }
  .dup-entry-puesto-label { font-size: 10px; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; text-align: right; }

  @keyframes slideUp {
    from { opacity: 0; transform: translateY(16px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     STATS DASHBOARD
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .stats-panel {
    display: none;
    width: 100%;
    max-width: 900px;
    position: relative; z-index: 1;
    animation: slideUp 0.4s ease;
  }
  .stats-panel.visible { display: block; }

  .stats-header {
    text-align: center; margin-bottom: 36px;
  }
  .stats-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: clamp(36px, 6vw, 58px);
    letter-spacing: 3px; color: var(--text); line-height: 1;
  }
  .stats-title span { color: var(--accent); }
  .stats-subtitle { color: var(--muted); font-size: 13px; margin-top: 8px; }

  .stats-back {
    display: inline-flex; align-items: center; gap: 8px;
    background: var(--surface2); border: 1px solid var(--border);
    color: var(--muted); font-size: 12px; font-weight: 600;
    letter-spacing: 1.5px; text-transform: uppercase;
    padding: 8px 16px; border-radius: 3px;
    cursor: pointer; margin-bottom: 30px;
    transition: color 0.15s, border-color 0.15s;
  }
  .stats-back:hover { color: var(--accent); border-color: rgba(232,200,74,0.4); }

  /* KPI Grid */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 14px; margin-bottom: 28px;
  }
  .kpi-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 4px; padding: 20px 18px;
    position: relative; overflow: hidden;
  }
  .kpi-card::after {
    content: '';
    position: absolute; bottom: 0; left: 0; right: 0; height: 2px;
  }
  .kpi-card.blue::after   { background: var(--info); }
  .kpi-card.green::after  { background: var(--success); }
  .kpi-card.yellow::after { background: var(--accent); }
  .kpi-card.orange::after { background: var(--accent2); }
  .kpi-card.red::after    { background: var(--error); }
  .kpi-card.purple::after { background: var(--purple); }

  .kpi-icon { font-size: 22px; margin-bottom: 10px; }
  .kpi-val {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 38px; letter-spacing: 1px; line-height: 1; color: var(--text);
  }
  .kpi-label { font-size: 11px; font-weight: 600; letter-spacing: 1.5px; text-transform: uppercase; color: var(--muted); margin-top: 4px; }

  /* Section titles */
  .sec-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 22px; letter-spacing: 2px;
    color: var(--text); margin-bottom: 14px;
    display: flex; align-items: center; gap: 10px;
  }
  .sec-title::after {
    content: ''; flex: 1; height: 1px;
    background: var(--border);
  }
  .sec-title span { color: var(--accent); }

  /* LÃ­deres ranking */
  .lider-bar-row {
    display: flex; align-items: center; gap: 12px;
    margin-bottom: 10px;
  }
  .lider-rank {
    font-family: 'Bebas Neue', sans-serif; font-size: 18px;
    color: var(--muted); width: 28px; text-align: right; flex-shrink: 0;
  }
  .lider-name { font-size: 14px; font-weight: 500; min-width: 140px; flex-shrink: 0; }
  .lider-bar-wrap { flex: 1; background: var(--surface2); border-radius: 2px; height: 22px; overflow: hidden; }
  .lider-bar {
    height: 100%; border-radius: 2px;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    display: flex; align-items: center; padding-left: 8px;
    transition: width 0.8s cubic-bezier(.2,.8,.3,1);
    min-width: 30px;
  }
  .lider-bar-val { font-family: 'Bebas Neue', sans-serif; font-size: 15px; color: #0a0e1a; }
  .lider-pct { font-size: 12px; color: var(--muted); width: 42px; text-align: right; flex-shrink: 0; }

  /* Bottom lÃ­deres */
  .bottom-lider-row {
    display: flex; align-items: center; gap: 12px; margin-bottom: 10px;
  }
  .bottom-bar-wrap { flex: 1; background: var(--surface2); border-radius: 2px; height: 22px; overflow: hidden; }
  .bottom-bar {
    height: 100%; border-radius: 2px;
    background: linear-gradient(90deg, #374151, #4b5563);
    display: flex; align-items: center; padding-left: 8px;
    min-width: 30px;
  }
  .bottom-bar-val { font-family: 'Bebas Neue', sans-serif; font-size: 15px; color: #9ca3af; }

  /* Dups table */
  .dup-section { margin-bottom: 28px; }
  .dup-table-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 4px; overflow: hidden; margin-bottom: 14px;
  }
  .dup-table-header {
    background: var(--surface2); padding: 14px 18px;
    display: flex; align-items: center; justify-content: space-between;
    border-bottom: 1px solid var(--border);
    cursor: pointer; user-select: none;
    transition: background 0.15s;
  }
  .dup-table-header:hover { background: #1f2d42; }
  .dup-table-cedula-num {
    font-family: 'Bebas Neue', sans-serif; font-size: 18px;
    letter-spacing: 1px; color: var(--text);
  }
  .dup-table-meta { font-size: 12px; color: var(--muted); margin-top: 2px; }
  .dup-table-toggle { color: var(--accent); font-size: 18px; transition: transform 0.2s; }
  .dup-table-toggle.open { transform: rotate(180deg); }
  .dup-table-body { display: none; }
  .dup-table-body.open { display: block; }
  .dup-row {
    padding: 12px 18px; border-bottom: 1px solid var(--border);
    display: grid; grid-template-columns: 1fr 1fr auto;
    gap: 10px; align-items: center;
  }
  .dup-row:last-child { border-bottom: none; }
  .dup-row-lider { font-size: 13px; font-weight: 600; color: var(--text); }
  .dup-row-nombre { font-size: 13px; color: var(--muted); }
  .name-match-pill {
    font-size: 10px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase;
    padding: 3px 8px; border-radius: 2px;
  }
  .name-match-pill.yes { background: rgba(16,185,129,0.15); color: var(--success); }
  .name-match-pill.no  { background: rgba(239,68,68,0.12); color: var(--error); }
  .dup-consistency-badge {
    font-size: 11px; font-weight: 600; letter-spacing: 1px;
    padding: 4px 10px; border-radius: 2px; margin-left: 8px;
  }
  .dup-consistency-badge.ok  { background: rgba(16,185,129,0.1); color: var(--success); border: 1px solid rgba(16,185,129,0.25); }
  .dup-consistency-badge.bad { background: rgba(239,68,68,0.1); color: var(--error); border: 1px solid rgba(239,68,68,0.25); }

  /* Lugares */
  .lugar-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 28px;
  }
  .lugar-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 3px;
    padding: 14px 16px;
    display: flex; align-items: center; gap: 12px;
  }
  .lugar-count {
    font-family: 'Bebas Neue', sans-serif; font-size: 28px;
    color: var(--accent); flex-shrink: 0; min-width: 50px;
  }
  .lugar-name { font-size: 13px; font-weight: 500; line-height: 1.3; }
  .lugar-pct  { font-size: 11px; color: var(--muted); }

  /* Loading overlay for stats */
  .stats-loading {
    display: none; text-align: center; padding: 60px 20px;
    position: relative; z-index: 1;
  }
  .stats-loading.visible { display: block; }
  .stats-loading-spinner {
    width: 40px; height: 40px; margin: 0 auto 16px;
    border: 3px solid rgba(232,200,74,0.2);
    border-top-color: var(--accent);
    border-radius: 50%; animation: spin 0.8s linear infinite;
  }
  .stats-loading-text {
    font-family: 'Bebas Neue', sans-serif; font-size: 20px;
    letter-spacing: 2px; color: var(--muted);
  }

  @media (max-width: 600px) {
    .lugar-grid { grid-template-columns: 1fr; }
    .kpi-grid { grid-template-columns: 1fr 1fr; }
    .dup-row { grid-template-columns: 1fr 1fr; }
    .dup-row .name-match-pill { display: none; }
    .lider-name { min-width: 100px; font-size: 12px; }
    .stats-panel { max-width: 100%; }
  }
</style>
</head>
<body>

<!-- â”€â”€ SEARCH PANEL â”€â”€ -->
<div class="container" id="searchPanel">
  <div class="header">
    <div class="badge">Sistema Electoral</div>
    <h1>CONSULTA<br><span>VOTANTE</span></h1>
    <p class="subtitle">Ingresa tu cÃ©dula â€” escribe <strong style="color:var(--accent)">stats</strong> para ver estadÃ­sticas</p>
  </div>

  <div class="search-card">
    <label for="cedula">NÃºmero de cÃ©dula</label>
    <div class="input-row">
      <input type="text" id="cedula" placeholder="Ej: 1082405787 o stats" maxlength="20" inputmode="numeric" />
      <button id="btnBuscar" onclick="buscar()">BUSCAR</button>
    </div>
    <div class="status-msg" id="statusMsg"></div>
  </div>

  <!-- Resultado Ãºnico -->
  <div class="result-card" id="resultCard">
    <div class="result-header">
      <div class="check-icon">âœ“</div>
      <div>
        <div class="result-name" id="resNombre">â€”</div>
        <div class="result-cedula" id="resCedula">â€”</div>
      </div>
    </div>
    <div class="info-grid">
      <div class="info-item full">
        <div class="info-label">ğŸ“ Lugar de VotaciÃ³n</div>
        <div class="info-value" id="resLugar">â€”</div>
      </div>
      <div class="info-item">
        <div class="info-label">ğŸ—³ï¸ Mesa (Puesto)</div>
        <div class="info-value highlight" id="resPuesto">â€”</div>
      </div>
      <div class="info-item">
        <div class="info-label">ğŸ‘¤ LÃ­der</div>
        <div class="info-value" id="resLider">â€”</div>
      </div>
    </div>
    <div class="unique-badge" id="uniqueBadge">âœ” Registro Ãºnico â€” sin duplicados</div>
  </div>

  <!-- Duplicados -->
  <div class="dup-card" id="dupCard">
    <div class="dup-header">
      <div class="warn-icon">âš ï¸</div>
      <div>
        <div class="dup-title">CÃ‰DULA DUPLICADA</div>
        <div class="dup-cedula-label" id="dupCedula">â€”</div>
      </div>
    </div>
    <div class="dup-count-pill" id="dupCountPill">â€” registros encontrados</div>
    <div class="dup-list" id="dupList"></div>
  </div>
</div>

<!-- â”€â”€ STATS LOADING â”€â”€ -->
<div class="stats-loading" id="statsLoading">
  <div class="stats-loading-spinner"></div>
  <div class="stats-loading-text">CARGANDO ESTADÃSTICAS...</div>
</div>

<!-- â”€â”€ STATS PANEL â”€â”€ -->
<div class="stats-panel" id="statsPanel">
  <button class="stats-back" onclick="volverBusqueda()">â† VOLVER A CONSULTA</button>

  <div class="stats-header">
    <div class="badge">AnÃ¡lisis de Base de Datos</div>
    <div class="stats-title">PANEL DE<br><span>ESTADÃSTICAS</span></div>
    <div class="stats-subtitle" id="statsTimestamp">â€”</div>
  </div>

  <!-- KPIs -->
  <div class="kpi-grid" id="kpiGrid"></div>

  <!-- Top lÃ­deres -->
  <div class="sec-title">LÃDERES <span>TOP</span></div>
  <div id="topLideres" style="margin-bottom:28px;"></div>

  <!-- Bottom lÃ­deres -->
  <div class="sec-title">LÃDERES CON <span>MENOS REGISTROS</span></div>
  <div id="bottomLideres" style="margin-bottom:28px;"></div>

  <!-- Duplicados -->
  <div class="sec-title">CÃ‰DULAS <span>DUPLICADAS</span></div>
  <div id="dupSection" style="margin-bottom:28px;"></div>

  <!-- Lugares -->
  <div class="sec-title">DISTRIBUCIÃ“N POR <span>LUGAR</span></div>
  <div class="lugar-grid" id="lugarGrid"></div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxD6GFonTCEgeIee96dnazo_t_tvmTf2zyfKCJSAyb08wzYnOhGvgjFVC9PL86EW0-sKw/exec';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showStatus(msg, type) {
  const el = document.getElementById('statusMsg');
  el.innerHTML = type === 'loading' ? `<div class="spinner"></div>${msg}` : msg;
  el.className = 'status-msg ' + type;
}
function hideStatus() { document.getElementById('statusMsg').className = 'status-msg'; }
function hideAllResults() {
  document.getElementById('resultCard').classList.remove('visible');
  document.getElementById('dupCard').classList.remove('visible');
}
function setField(id, value, highlight = false) {
  const el = document.getElementById(id);
  const empty = !value || value.toString().trim() === '' || value === 'No aplica';
  el.textContent = empty ? 'No aplica' : value;
  el.className = 'info-value' + (highlight && !empty ? ' highlight' : '') + (empty ? ' na' : '');
}
function volverBusqueda() {
  document.getElementById('statsPanel').classList.remove('visible');
  document.getElementById('statsLoading').classList.remove('visible');
  document.getElementById('searchPanel').style.display = 'flex';
  document.getElementById('cedula').value = '';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BÃšSQUEDA PRINCIPAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function buscar() {
  const raw = document.getElementById('cedula').value.trim();

  // â”€â”€ Comando stats â”€â”€
  if (raw.toLowerCase() === 'stats') {
    cargarStats();
    return;
  }

  const cedula = raw;
  if (!cedula) { showStatus('Por favor ingresa un nÃºmero de cÃ©dula.', 'error'); return; }

  const btn = document.getElementById('btnBuscar');
  btn.disabled = true;
  hideAllResults();
  showStatus('Consultando...', 'loading');

  try {
    const res = await fetch(`${SCRIPT_URL}?cedula=${encodeURIComponent(cedula)}`);
    if (!res.ok) throw new Error();
    const data = await res.json();
    handleResponse(data, cedula);
  } catch {
    showStatus('âš ï¸ Error al conectar con el servidor. Intenta de nuevo.', 'error');
  }
  btn.disabled = false;
}

function handleResponse(data, cedula) {
  hideStatus(); hideAllResults();
  if (!data.found) { showStatus('âŒ CÃ©dula no encontrada en el registro.', 'error'); return; }

  let registros = Array.isArray(data.registros) && data.registros.length
    ? data.registros
    : [{ nombre: data.nombre, lider: data.lider, lugar: data.lugar, puesto: data.puesto }];

  if (registros.length === 1) {
    const r = registros[0];
    document.getElementById('resNombre').textContent = r.nombre || 'No aplica';
    document.getElementById('resCedula').textContent = 'CC ' + cedula;
    setField('resLugar', r.lugar);
    setField('resPuesto', r.puesto, true);
    setField('resLider', r.lider);
    document.getElementById('uniqueBadge').style.display = 'inline-flex';
    document.getElementById('resultCard').classList.add('visible');
  } else {
    document.getElementById('dupCedula').textContent = 'CC ' + cedula;
    document.getElementById('dupCountPill').textContent = registros.length + ' registros encontrados para esta cÃ©dula';

    const nombreRef = (registros[0].nombre || '').trim().toUpperCase();
    const allMatch = registros.every(r => (r.nombre || '').trim().toUpperCase() === nombreRef);

    const list = document.getElementById('dupList');
    list.innerHTML = '';
    registros.forEach(r => {
      const lider  = r.lider  || 'Sin lÃ­der';
      const lugar  = r.lugar  || 'No aplica';
      const puesto = r.puesto || 'â€”';
      const nombre = r.nombre || 'Sin nombre';
      const matchesRef = (nombre.trim().toUpperCase() === nombreRef);

      const entry = document.createElement('div');
      entry.className = 'dup-entry';
      entry.innerHTML = `
        <div>
          <div class="dup-entry-nombre">ğŸ‘¤ ${lider}</div>
          <div class="dup-entry-meta">${lugar}</div>
          <div>
            <span class="dup-name-badge ${matchesRef && !allMatch ? 'match' : (!matchesRef ? 'diff' : 'match')}">
              ${nombre}
            </span>
            ${!allMatch && !matchesRef ? '<span class="dup-name-badge diff" style="margin-left:4px">Nombre diferente</span>' : ''}
          </div>
        </div>
        <div>
          <div class="dup-entry-puesto">${puesto}</div>
          <div class="dup-entry-puesto-label">Mesa</div>
        </div>
      `;
      list.appendChild(entry);
    });
    document.getElementById('dupCard').classList.add('visible');
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function cargarStats() {
  document.getElementById('searchPanel').style.display = 'none';
  document.getElementById('statsLoading').classList.add('visible');

  try {
    const res = await fetch(`${SCRIPT_URL}?action=stats`);
    if (!res.ok) throw new Error();
    const data = await res.json();
    renderStats(data);
  } catch {
    // Si el backend no soporta ?action=stats, muestra error elegante
    document.getElementById('statsLoading').classList.remove('visible');
    document.getElementById('searchPanel').style.display = 'flex';
    showStatus('âš ï¸ El servidor no soporta estadÃ­sticas o hubo un error de conexiÃ³n.', 'error');
  }
}

function renderStats(data) {
  document.getElementById('statsLoading').classList.remove('visible');

  /* El backend debe devolver:
     {
       total: number,
       totalUnicos: number,
       totalLideres: number,
       totalLugares: number,
       cedulasDuplicadas: number,
       lideres: [ { nombre, count } ],          // todos, ordenado desc
       lugares: [ { nombre, count } ],           // todos
       duplicados: [
         { cedula, registros: [ { lider, nombre, puesto, lugar } ] }
       ]
     }
  */

  const now = new Date();
  document.getElementById('statsTimestamp').textContent =
    'Generado el ' + now.toLocaleDateString('es-CO', { day:'2-digit', month:'long', year:'numeric' })
    + ' a las ' + now.toLocaleTimeString('es-CO', { hour:'2-digit', minute:'2-digit' });

  const total      = data.total || 0;
  const unicos     = data.totalUnicos || 0;
  const lideres    = data.lideres || [];
  const lugares    = data.lugares || [];
  const dups       = data.duplicados || [];
  const totalLider = data.totalLideres || lideres.length;
  const totalLugar = data.totalLugares || lugares.length;

  /* â”€â”€â”€ KPIs â”€â”€â”€ */
  const kpis = [
    { icon: 'ğŸ—‚ï¸', val: total.toLocaleString('es-CO'), label: 'Total Registros', cls: 'blue' },
    { icon: 'ğŸªª', val: unicos.toLocaleString('es-CO'), label: 'CÃ©dulas Ãšnicas', cls: 'green' },
    { icon: 'ğŸ‘¥', val: totalLider, label: 'LÃ­deres', cls: 'yellow' },
    { icon: 'ğŸ“', val: totalLugar, label: 'Lugares de VotaciÃ³n', cls: 'purple' },
    { icon: 'âš ï¸', val: dups.length, label: 'CÃ©dulas Duplicadas', cls: 'orange' },
    { icon: 'ğŸ“Š', val: total > 0 ? (total / Math.max(totalLider,1)).toFixed(1) : '0', label: 'Promedio / LÃ­der', cls: 'red' },
  ];
  const kpiGrid = document.getElementById('kpiGrid');
  kpiGrid.innerHTML = kpis.map(k => `
    <div class="kpi-card ${k.cls}">
      <div class="kpi-icon">${k.icon}</div>
      <div class="kpi-val">${k.val}</div>
      <div class="kpi-label">${k.label}</div>
    </div>
  `).join('');

  /* â”€â”€â”€ Top LÃ­deres â”€â”€â”€ */
  const maxCount = lideres.length ? lideres[0].count : 1;
  const top = lideres.slice(0, 15);
  document.getElementById('topLideres').innerHTML = top.map((l, i) => {
    const pct = Math.round((l.count / total) * 100);
    const barW = Math.max(4, Math.round((l.count / maxCount) * 100));
    return `
      <div class="lider-bar-row">
        <div class="lider-rank">${i + 1}</div>
        <div class="lider-name">${l.nombre}</div>
        <div class="lider-bar-wrap">
          <div class="lider-bar" style="width:${barW}%">
            <span class="lider-bar-val">${l.count}</span>
          </div>
        </div>
        <div class="lider-pct">${pct}%</div>
      </div>`;
  }).join('');

  /* â”€â”€â”€ Bottom LÃ­deres â”€â”€â”€ */
  const bottom = [...lideres].sort((a,b) => a.count - b.count).slice(0, 10);
  const minCount = bottom.length ? bottom[0].count : 1;
  document.getElementById('bottomLideres').innerHTML = bottom.map((l, i) => {
    const pct = Math.round((l.count / total) * 100);
    const barW = Math.max(4, Math.round((l.count / maxCount) * 100));
    return `
      <div class="bottom-lider-row">
        <div class="lider-rank">${i + 1}</div>
        <div class="lider-name">${l.nombre}</div>
        <div class="bottom-bar-wrap">
          <div class="bottom-bar" style="width:${barW}%">
            <span class="bottom-bar-val">${l.count}</span>
          </div>
        </div>
        <div class="lider-pct">${pct}%</div>
      </div>`;
  }).join('');

  /* â”€â”€â”€ Duplicados â”€â”€â”€ */
  const dupSection = document.getElementById('dupSection');
  if (!dups.length) {
    dupSection.innerHTML = `<div style="color:var(--success);font-size:14px;padding:20px;background:rgba(16,185,129,0.07);border:1px solid rgba(16,185,129,0.2);border-radius:3px;text-align:center;">
      âœ… No se encontraron cÃ©dulas duplicadas en la base de datos.
    </div>`;
  } else {
    dupSection.innerHTML = dups.map(d => {
      const nombres = d.registros.map(r => (r.nombre || '').trim().toUpperCase());
      const allNombresMatch = nombres.every(n => n === nombres[0]);
      const rows = d.registros.map(r => {
        const nameMatch = (r.nombre || '').trim().toUpperCase() === nombres[0];
        return `
          <div class="dup-row">
            <div class="dup-row-lider">ğŸ‘¤ ${r.lider || 'Sin lÃ­der'}</div>
            <div class="dup-row-nombre">${r.nombre || 'â€”'}</div>
            <div>
              <span class="name-match-pill ${nameMatch ? 'yes' : 'no'}">
                ${nameMatch ? 'Nombre âœ“' : 'Diferente'}
              </span>
            </div>
          </div>`;
      }).join('');

      return `
        <div class="dup-table-card">
          <div class="dup-table-header" onclick="toggleDup(this)">
            <div>
              <div class="dup-table-cedula-num">
                CC ${d.cedula}
                <span class="dup-consistency-badge ${allNombresMatch ? 'ok' : 'bad'}">
                  ${allNombresMatch ? 'Nombres coinciden' : 'Nombres distintos'}
                </span>
              </div>
              <div class="dup-table-meta">${d.registros.length} registros Â· LÃ­deres: ${d.registros.map(r => r.lider || 'Sin lÃ­der').join(', ')}</div>
            </div>
            <div class="dup-table-toggle">â–¾</div>
          </div>
          <div class="dup-table-body">
            ${rows}
          </div>
        </div>`;
    }).join('');
  }

  /* â”€â”€â”€ Lugares â”€â”€â”€ */
  const lugarGrid = document.getElementById('lugarGrid');
  lugarGrid.innerHTML = lugares.map(l => {
    const pct = total > 0 ? Math.round((l.count / total) * 100) : 0;
    return `
      <div class="lugar-card">
        <div class="lugar-count">${l.count}</div>
        <div>
          <div class="lugar-name">${l.nombre}</div>
          <div class="lugar-pct">${pct}% del total</div>
        </div>
      </div>`;
  }).join('');

  document.getElementById('statsPanel').classList.add('visible');
}

function toggleDup(header) {
  const body   = header.nextElementSibling;
  const toggle = header.querySelector('.dup-table-toggle');
  const isOpen = body.classList.contains('open');
  body.classList.toggle('open', !isOpen);
  toggle.classList.toggle('open', !isOpen);
}

/* â”€â”€â”€ Enter key â”€â”€â”€ */
document.getElementById('cedula').addEventListener('keydown', e => {
  if (e.key === 'Enter') buscar();
});
</script>
</body>
</html>
